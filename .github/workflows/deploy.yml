name: Deploy to DigitalOcean

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

env:
  DROPLET_HOST: 67.205.161.183
  STAGING_DOMAIN: staging.myaigency.com
  STAGING_PATH: /var/www/staging.myaigency.com
  PRODUCTION_DOMAIN: myaigency.com
  PRODUCTION_PATH: /var/www/myaigency.com

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to IMAGE-TEAM Droplet

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DROPLET_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.DROPLET_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy site files to droplet
        run: |
          echo "Deploying to ${{ env.DROPLET_HOST }}..."
          echo "Deploying to staging (${{ env.STAGING_DOMAIN }})..."
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.do' \
            --exclude='node_modules' \
            --exclude='DEPLOYMENT.md' \
            --exclude='README.md' \
            ./site/ root@${{ env.DROPLET_HOST }}:${{ env.STAGING_PATH }}/

          echo "Deploying to production (${{ env.PRODUCTION_DOMAIN }})..."
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.do' \
            --exclude='node_modules' \
            --exclude='DEPLOYMENT.md' \
            --exclude='README.md' \
            ./site/ root@${{ env.DROPLET_HOST }}:${{ env.PRODUCTION_PATH }}/

      - name: Set permissions and reload Nginx
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@${{ env.DROPLET_HOST }} << 'ENDSSH'
            chown -R www-data:www-data ${{ env.STAGING_PATH }}
            chmod -R 755 ${{ env.STAGING_PATH }}
            chown -R www-data:www-data ${{ env.PRODUCTION_PATH }}
            chmod -R 755 ${{ env.PRODUCTION_PATH }}
            nginx -t && systemctl reload nginx
            echo "Deployment completed at $(date)"
          ENDSSH

      - name: Verify deployment
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ðŸŒ Staging: https://${{ env.STAGING_DOMAIN }}"
          echo "ðŸŒ Production: https://${{ env.PRODUCTION_DOMAIN }}"
          curl -I https://${{ env.STAGING_DOMAIN }} | head -5
          echo "---"
          curl -I https://${{ env.PRODUCTION_DOMAIN }} | head -5

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key

  notify:
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    name: Deployment notification

    steps:
      - name: Deployment status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Deployment successful!"
            echo "ðŸŒ Staging: https://${{ env.STAGING_DOMAIN }}"
            echo "ðŸŒ Production: https://${{ env.PRODUCTION_DOMAIN }}"
          else
            echo "âŒ Deployment failed"
            exit 1
          fi
